(function(){function y(){window.requestAnimationFrame(y);var a=Date.now();var b=a-z;w=(4*w+b)/5;if(b){z=a;for(var d=Math.pow(.001,b/1E3),c=0;c<n.length;++c)b=n[c],b.alive&&(b.ex*=d,b.ey*=d);for(;A<a;){for(c=0;c<n.length;++c){b=n[c];var d=b.dx-b.x,e=b.dy-b.y,l=d*d+e*e;16<l&&(l=4/Math.sqrt(l),d*=l,e*=l);b.x+=d;b.y+=e}A+=20}}a=F;b=a.canvas.height;c=a.canvas.width;a.fillStyle="#37c";a.fillRect(0,0,c,b);for(d=0;256>d;++d){var g=n[d];if(g.type&&g.alive){var e=a,l=c,f=b,k=g.x+g.ex,u=g.y+g.ey;e.beginPath();e.arc(k/1600*l,u/900*f,g.r/1600*l,0,2*Math.PI);e.closePath();e.fillStyle=g.color;e.fill();e.beginPath();e.arc(g.x/1600*l,g.y/900*f,g.r/1600*l,0,2*Math.PI);e.closePath();e.lineWidth=2;e.strokeStyle="red";e.stroke();var r=e.createLinearGradient(g.x/1600*l,g.y/900*f,g.dx/1600*l,g.dy/900*f);r.addColorStop(0,"red");r.addColorStop(1,"rgba(255,0,0,0.25)");e.strokeStyle=r;e.moveTo(g.x/1600*l,g.y/900*f);e.lineTo(g.dx/1600*l,g.dy/900*f);e.stroke();if(h&&h.alive&&g!==h){var r=h.x+h.ex-k,p=h.y+h.ey-u,q=r*r+p*p;q>g.r*g.r&&(q=g.r/Math.sqrt(q),r*=q,p*=q);q=10+h.m/(h.m+g.m)*80;2===g.type&&(q=90+.1*q);e.font=.015*l+"px Verdana, sans-serif";e.textAlign="center";e.textBaseline="middle";e.fillStyle=70<q?"#0f0":40>q?"#f00":"#aaa";e.fillText(Math.round(q)+"%",(k+r)/1600*l,(u+p)/900*f)}e.font=.015*l+"px Verdana, sans-serif";e.textAlign="center";e.textBaseline="middle";g.name&&(e.fillStyle="#ccc",e.fillText(g.name,k/1600*l,(u/900-.01)*f));e.fillStyle="#eee";e.fillText(g.m.toLocaleString(),k/1600*l,(u/900+.01)*f)}}var t;m?0===m.readyState?t="Connecting":2===m.readyState?t="Disconnecting":h&&(t=h.score+" ("+h.kills+"/"+h.deaths+") ["+h.combo+"x COMBO]"):t="Disconnected";t&&(a.font=.04*c+"px sans-serif",a.textAlign="center",a.fillStyle="#ddd",a.fillText(t,.5*c,.15*b));t=1E3/Math.max(w,.5);a.font=.02*c+"px monospace";a.textAlign="left";a.fillStyle="#fa0";a.fillText(Math.round(t)+" fps",.01*c,.97*b)}function x(){window.innerWidth===window.screen.width&&window.innerHeight===window.screen.height?(f.width=Math.min(window.innerWidth,1600*window.innerHeight/900),f.height=Math.min(window.innerHeight,900*window.innerWidth/1600)):(f.width=Math.min(f.parentNode.clientWidth,1600*f.parentNode.clientHeight/900),f.height=Math.min(f.parentNode.clientHeight,900*f.parentNode.clientWidth/1600))}function G(){m=new WebSocket("wss://d-acrf.rhcloud.com:8443/d");m.binaryType="arraybuffer";m.onopen=H;m.onmessage=I;m.onclose=J;k("connect").innerHTML="Disconnect";k("connect").className="btn btn-danger"}function K(){m.close()}function J(){h=m=void 0;k("connect").innerHTML="Connect";k("connect").className="btn btn-primary"}function H(){for(var a=0;a<n.length;++a)n[a].type=0;var a=k("pName").value,b=B(),d=new ArrayBuffer(a.length+1);(new DataView(d)).setUint8(0,b);for(var b=new Uint8Array(d,1),c=0,e=a.length;c<e;++c)b[c]=a.charCodeAt(c);m.send(d)}function I(a){var b=a.data;a=new DataView(b);var d=a.getUint8(0);if(d)if(1===d||2===d){var c=a.getUint8(1),b=a.getUint32(2),e=a.getUint32(6),f=a.getUint32(10),g=a.getUint32(14),p=a.getUint8(18);a=String.fromCharCode.apply(null,new Uint8Array(a.buffer,19,void 0));c=n[c];c.type=d;c.kills=b;c.deaths=e;c.combo=f;c.score=g;c.alive=!1;c.name=a;c.color=C(p,d)}else if(3===d)a=a.getUint8(1),n[a].type=0;else if(4===d)for(d=1;d+13<=a.byteLength;d+=13)c=a.getUint8(d),b=1600*a.getUint16(d+1)/65535,e=900*a.getUint16(d+3)/65535,f=1600*a.getUint16(d+5)/65535,g=900*a.getUint16(d+7)/65535,p=a.getUint32(d+9),c=n[c],c.m=p,c.r=Math.sqrt(p),c.alive?(c.ex+=c.x-b,c.ey+=c.y-e):(c.alive=!0,c.ex=0,c.ey=0),c.x=b,c.y=e,c.dx=f,c.dy=g;else if(5===d)d=a.getUint8(1),a=a.getUint8(2),b=n[d],e=n[a],b.kills+=1,b.combo+=1,e.deaths+=1,e.alive=!1,e.combo=0,d===a?b.score--:b.score+=b.combo;else if(6===d)for(d=1;d+3<=a.byteLength;d+=3)b=a.getUint8(d),n[b].ping=a.getUint16(d+1);else 7===d&&9===b.byteLength&&m.send(b.slice(1));else a=a.getUint8(1),h=n[a],h.type=1,h.kills=0,h.deaths=0,h.combo=0,h.score=0,h.alive=!1,h.name=k("pName").value,h.color=C(B(),0)}function L(){if(m&&1===m.readyState&&h&&(.01<Math.abs(p-D)||.01<Math.abs(v-E))){var a=new ArrayBuffer(4),b=new DataView(a);b.setUint16(0,65535*(D=p)|0);b.setUint16(2,65535*(E=v)|0);m.send(a)}}function B(){var a=parseInt(k("pColor").value,16);Number.isNaN(a)&&(a=255*Math.random());return a&255}function C(a,b){return"hsl("+1.40625*a+","+(b?1===b?"80%,40%":"40%,20%":"90%,60%")+")"}function k(a){return document.getElementById(a)}var f=k("gameCanvas"),F=f.getContext("2d"),z=Date.now(),A=Date.now(),w=1E3,h,n=function(){for(var a=Array(256),b=0;256>b;++b)a[b]={type:0,name:"",color:"black",kills:0,deaths:0,combo:0,score:0,alive:0,x:0,y:0,ex:0,ey:0,dx:0,dy:0,m:1E3,r:10};return a}(),m,D=-1,E=-1,p=0,v=0;document.addEventListener("DOMContentLoaded",function(){function a(a,b){p=(a-f.getBoundingClientRect().left)/f.width;v=(b-f.getBoundingClientRect().top)/f.height}function b(a){h&&(p=h.x/1600,v=h.y/900)}function d(c){1>c.targetTouches.length||(c.preventDefault(),c=c.targetTouches.item(0),a(c.clientX,c.clientY))}x();window.requestAnimationFrame(y);f.addEventListener("mousemove",function(c){a(c.clientX,c.clientY)});f.addEventListener("touchstart",d);f.addEventListener("touchmove",d);f.addEventListener("mouseleave",b);f.addEventListener("touchend",b);f.addEventListener("touchcancel",b);k("hue").addEventListener("click",function(a){a=("0"+((a.clientX-a.target.getBoundingClientRect().left)/a.target.clientWidth*255|0).toString(16)).slice(-2);window.localStorage.c=k("pColor").value=a});k("connect").addEventListener("click",function(){(m?K:G)()});k("fullscreen").addEventListener("click",function(){k("fullscreen").checked=!1;var a;["requestFullScreen","mozRequestFullScreen","msRequestFullscreen","webkitRequestFullScreen"].forEach(function(b){a=a||f[b]});a&&a.call(f)});k("pName").addEventListener("change",function(){window.localStorage.n=this.value});k("pColor").addEventListener("change",function(){window.localStorage.c=this.value});document.addEventListener("fullscreenchange",function(){x()});window.addEventListener("resize",function(){x()});window.localStorage.n&&(k("pName").value=window.localStorage.n);window.localStorage.c&&(k("pColor").value=window.localStorage.c);setInterval(L,40)})})();